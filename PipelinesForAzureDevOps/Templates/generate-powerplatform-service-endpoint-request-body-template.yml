# Pipeline template for the generation of a file containing the request body for the creation of a Power Platform service endpoint in the branch from which the parent pipeline was triggered

parameters:
- name: ENVIRONMENT_NAME # Name of the Power Platform environment you want to create a service endpoint for
  type: string
  default: ''
- name: TENANT_ID # Azure tenant id considered
  type: string
  default: ''
- name: APPLICATION_ID # ID of the Azure AD application registered for the integration between the Power Platform and Azure DevOps
  type: string
  default: ''
- name: CLIENT_SECRET # Client secret of the Azure AD application registered for the integration between the Power Platform and Azure DevOps
  type: string
  default: ''
- name: POWER_PLATFORM_ENVIRONMENT_URL # URL of the Power Platform environment you want to create a service endpoint for
  type: string
  default: ''
- name: BRANCH_NAME # Current Branch Name
  type: string
  default: ''
- name: CURRENT_PROJECT_ID # Current Project ID
  type: string
  default: ''
- name: CURRENT_PROJECT_NAME # Current Project Name
  type: string
  default: ''

steps:
# Make a copy of the "powerplatform-spn-template.json" file to the "ServiceEndpointCreation_RequestBodies" folder
- task: CopyFiles@2
  inputs:
    SourceFolder: '$(System.DefaultWorkingDirectory)/ServiceEndpoints'
    Contents: 'powerplatform-spn-template.json'
    TargetFolder: '$(System.DefaultWorkingDirectory)/ServiceEndpoints/ServiceEndpointCreation_RequestBodies'

# Rename the new field copied from the "powerplatform-spn-template.json" file
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: 'rename-item –path $(System.DefaultWorkingDirectory)/ServiceEndpoints/ServiceEndpointCreation_RequestBodies/powerplatform-spn-template.json –newname $(System.DefaultWorkingDirectory)/ServiceEndpoints/ServiceEndpointCreation_RequestBodies/powerplatform-spn-${{ parameters.ENVIRONMENT_NAME }}.json'

# Replace the parameters in the request body for the creation of the Power Platform service endpoint
- powershell: |
    $content = Get-Content -Path '$(System.DefaultWorkingDirectory)/ServiceEndpoints/ServiceEndpointCreation_RequestBodies/powerplatform-spn-${{ parameters.ENVIRONMENT_NAME }}.json'

    $contentTenantIdUpdated = $content -replace '<TenantId>', '${{ parameters.TENANT_ID }}'
    $contentApplicationIdUpdated = $contentTenantIdUpdated -replace '<ApplicationId>', '${{ parameters.APPLICATION_ID }}'
    $contentClientSecretUpdated = $contentApplicationIdUpdated -replace '<ClientSecret>', '${{ parameters.CLIENT_SECRET }}'
    $contentServiceEndpointNameUpdated = $contentClientSecretUpdated -replace '<ServiceEndpointName>', '${{ parameters.ENVIRONMENT_NAME }}'
    $contentProjectIdUpdated = $contentServiceEndpointNameUpdated -replace '<ProjectId>', '${{ parameters.CURRENT_PROJECT_ID }}'
    $contentProjectNameUpdated = $contentProjectIdUpdated -replace '<ProjectName>', '${{ parameters.CURRENT_PROJECT_NAME }}'
    $contentEnvironmentURLUpdated = $contentProjectNameUpdated -replace '<PowerPlatformEnvironmentURL>', '${{ parameters.POWER_PLATFORM_ENVIRONMENT_URL }}'

    $contentEnvironmentURLUpdated | Set-Content -Path '$(System.DefaultWorkingDirectory)/ServiceEndpoints/ServiceEndpointCreation_RequestBodies/powerplatform-spn-${{ parameters.ENVIRONMENT_NAME }}.json'

# Commit the changes (creation of the file with the request body for the creation of the Power Platform service endpoint) to the considered branch
- task: CmdLine@2
  inputs:
    script: |
      echo commit all changes
      git config user.email "$(Email)"
      git config user.name "Automatic Build"

      echo branch full name ${{ parameters.BRANCH_NAME }}
      git checkout ${{ parameters.BRANCH_NAME }}
      git add --all
      git commit -m "Power Platform service endpoint creation request body file generation"
         
      echo push code to new repo
      git -c http.extraheader="AUTHORIZATION: bearer $(System.AccessToken)" push origin ${{ parameters.BRANCH_NAME }}